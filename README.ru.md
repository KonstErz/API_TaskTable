# API TaskTable

| [English version](https://github.com/KonstErz/API_TaskTable/blob/master/README.md) |

### API реализован с помощью инструментов Django, Django REST framework и Celery

---


# Структура базы данных

База данных сервиса представлена следующими объектами и моделями (http://localhost:1337/admin/)

## Модели API приложения

+ **ЗАДАЧА** (*Task*)
Имеет поля: 
*Name* - наименование задачи (это поле уникально); 
*Specification* - детальное описание задачи; 
*Due date* - срок истечения задачи (дедлайн);
*Creator* - создатель задачи (внешний ключ к модели User);
*Performer* - исполнитель задачи (внешний ключ к модели User);
*Status* - текущий статус задачи, предоставляет выбор из трех значений: *n* - Новая, *w* - В работе, *c* - Завершенная

+ **КОММЕНТАРИЙ** (*Comment*)
Имеет поля: 
*Task* - задача, к которой адресован комментарий (внешний ключ к модели Task); 
*Description* - текст комментария; 
*Author* - автор комментария (внешний ключ к модели User);
*Post date* - дата публикации комментария

## Токены авторизации

+ **ТОКЕНЫ** (*Tokens*)
Имеет поля: 
*Key* - токен авторизации пользователя, создаваемый при регистрации нового пользователя в системе;
*User* - имя пользователя (username профиля пользователя); 
*Created* - дата и время создания токена (регистрации пользователя в системе)

## Данные аутентификации и авторизации

+ **ГРУППЫ** (*Groups*) - группы пользователей

+ **ПОЛЬЗОВАТЕЛИ** (*Users*)
Профиль пользователя имеет поля: 
*Username* - имя пользователя; 
*Email Address* - адрес электронной почты;
*First Name* - имя; 
*Last Name* - фамилия; 
*Staff Status* - статус сотрудника, определяющий права доступа пользователя в системе

## Результаты Celery и Периодические задачи

Результаты выполненных задач Celery и данные о периодических задачах Celery beat.

---


# Основной функционал API приложения

API предоставляет 6 основных функциональных модулей, к которым можно получить доступ либо через отдельные конечные точки, поддерживающие ввод в формате *application/json*, либо через функционал *TaskViewSet*, который поддерживает как HTML-форму, так и ввод Raw данных.


1.	**РЕГИСТРАЦИЯ ПОЛЬЗОВАТЕЛЯ**    (*Registration*)

(http://localhost:1337/api/registration/)

Создает нового пользователя в системе, токен авторизации пользователя в системе.
Возвращает токен авторизации нового пользователя.

***Sample input content:***     `{"username": "Peter", "email": "pparker62@gmail.com", "password": "secretpasswd951"}`

где поля: 
*username* - желаемое имя профиля пользователя в системе; 
*email* - адрес электронной почты;
*password* - пароль для авторизации пользователя в системе


2.	**АВТОРИЗАЦИЯ**    (*Login*)

(http://localhost:1337/api/login/)

Проводит аутентификацию пользователя в системе, осуществляет вход пользователя в его профиль, предоставляет права на проведение остальных операций в системе. 
Возвращает идентификатор пользователя или ошибку с кодом 400 в случае неудачной аутентификации.

***Sample input content:***     `{"username": "Peter", "password": "secretpasswd951"}`

где поля: 
*username* - имя профиля пользователя в системе; 
*password* - пароль для авторизации пользователя в системе


3.	**ВЫХОД ИЗ СИСТЕМЫ**    (*Logout*)

(http://localhost:1337/api/logout/)

POST-запрос на этот адрес приведет к выходу пользователя из системы.


4.	**СОЗДАНИЕ ЗАДАЧИ**   (*Task Creation*)

(http://localhost:1337/api/taskcreation/)

Авторизованный пользователь может создать новую задачу. Этот пользователь будет автоматически определен как создатель задачи, статус новой задачи по умолчанию - «Новая». При создании новой задачи ее имя должно быть уникальным.
Возвращает идентификатор новой задачи, если данные верны.

***Sample input content:*** 
`{"name": "NY is in danger!", "specification": "Venom is planning something terrible. Need to know about his plans as soon as possible.", "due_date": "2020-12-20", "performer": "Peter"}`


5.	**ОБНОВЛЕНИЕ ЗАДАЧИ** (*Task Update*)

(http://localhost:1337/api/taskupdate/)

Функция позволяет редактировать существующую задачу. Только авторизованные создатель и исполнитель задачи имеют право редактировать ее. Только создатель задачи может сменить исполнителя.
Возвращает сообщение об успешном обновлении задачи или об ошибке 403, если исполнитель задачи пытается сменить себя.

***Sample input content:*** 
`{"task_id": 1, "name": "NY is in danger! Again...", "specification": "Venom is planning something terrible. Need to know about his plans as soon as possible.", "due_date": "2020-12-24", "performer": "Peter", "status": "w"}`

где поле: 
*task_id* - идентификатор задачи, которую вы желаете обновить


6.	**ДОБАВЛЕНИЕ КОММЕНТАРИЯ**  (*Add comment*)

(http://localhost:1337/api/addcomment/)

Реализует добавление комментария к указанной задаче. Запрашивающий пользователь будет автором комментария. Любые авторизованные пользователи могут комментировать задачи.
Возвращает сообщение об успешном добавлении комментария.

***Sample input content:*** 
`{"task_name": "NY is in danger! Again...", "description": "Well, I got faith in you, Peter. You can do it =*"}`

где поле: 
*task_name* - наименование задачи, которую вы желаете прокомментировать


## TaskViewSet


+ **API ROOT**

(http://localhost:1337/api/)

Базовое корневое представление по умолчанию для DefaultRouter.


+ **СПИСОК ЗАДАЧ** (*Task List*)

(http://localhost:1337/api/tasks/)

Реализует отображение списка задач. Задачи отображаются посредством пагинации по 10 задач на одну страницу. Сортировка в порядке убывания срока выполнения. Каждый элемент отображает информацию о модели Задачи, включая информацию о пользователях задачи (создателе и исполнителе) и URL-адрес страницы с более подробной информацией. Список задач включает фильтр поиска по имени задачи и имени исполнителя (кнопка *Filters* в правом верхнем углу экрана). Только авторизованные пользователи имеют доступ к этой и всем последующим страницам. Внизу страницы находится HTML-форма (или форма Raw данных), заполнив которую, вы можете отправить POST-запрос на сервер для создания новой задачи. Запрашивающий пользователь будет создателем задачи.


+ **ЗАДАЧА**    (*Task Instance*)

(http://localhost:1337/api/tasks/1/ , где *1* - идентификатор задачи)

Реализует отображение детальной информации о задаче, включая информацию о пользователях задачи (создателе и исполнителе) и всех комментариях к ней. Комментарии к задачам отсортированы в порядке убывания даты публикации и включают подробную информацию об авторе (пользователе). Вы можете добавить новый комментарий к задаче, используя опцию *Add comment* (на вкладке *Extra Actions* в правом верхнем углу экрана). Создатель и исполнитель задачи может использовать HTML-форму (или форму Raw данных) внизу этой страницы, чтобы отправить PUT-запрос на сервер и отредактировать задачу (только создатель задачи может сменить исполнителя).


+ **ДОБАВЛЕНИЕ КОММЕНТАРИЯ**  (*Add comment*)

(http://localhost:1337/api/tasks/1/add_comment/ , где *1* - идентификатор задачи)

Включает HTML-форму (или форму Raw данных) для добавления нового комментария к текущей задаче (POST-запрос на сервер). Запрашивающий пользователь будет автором комментария. Любые авторизованные пользователи могут комментировать задачи.


## Дополнительный функционал API приложения


+ **Отправка электронных писем**

Задачи Celery в этом проекте сконфигурированы таким образом, что могут отправлять электронные письма создателям и исполнителям задач. Электронное письмо отправляется при создании новой задачи, обновлении задачи и добавлении комментария к задаче. В письме содержится подробная и актуальная информация о задаче, с которой проводились манипуляции, или о комментарии, если он был опубликован.

***Внимание!***
EmailBackend этого приложения подключается к Google почте через SMTP. Поэтому, чтобы активировать эту опцию, в настройках проекта вам необходимо указать фактический адрес электронной почты и пароль для вашей учетной записи Google (см. переменные *EMAIL_HOST_USER* и *EMAIL_HOST_PASSWORD* в файле *env.prod.example*), от имени которой Django будет отправлять электронные письма. Вам также необходимо будет включить опцию ["Ненадежные приложения, у которых есть доступ к аккаунту"](https://myaccount.google.com/lesssecureapps) во вкладке "Безопасность" в вашем Google аккаунте. Кроме того, вам может потребоваться выполнить инструкции, приведенные по этой [ссылке](https://accounts.google.com/DisplayUnlockCaptcha). Для этих целей вы можете использовать как личную учетную запись Google, так и специально созданную фейковую учетную запись. Но никогда не выкладывайте свои личные пароли публично! Для получения дополнительной информации смотрите [Справка - Gmail](https://support.google.com/mail/answer/7126229?hl=ru).

В случае проблем с отправкой писем Celery запишет в лог предупреждающее сообщение. Убедитесь, что вы правильно ввели данные для своего аккаунта Google и выполнили указанные выше действия. Celery производит 3 попытки с интервалом 5 минут отправки проблемного электронного письма.


+ **Загрузка медиафайлов**  (*Upload*)

(http://localhost:1337/upload/)

В приложение *upload* реализована небольшая функция, которую вы можете использовать для загрузки медиафайлов. Используйте кнопку *Browse*, чтобы выбрать файл (изображение) из ваших локальных директорий. Нажмите *Submit*, чтобы загрузить выбранный файл на сервер. Теперь изображение будет доступно по адресу http://localhost:1337/mediafiles/image_file_name.

---

### Особенности сервиса


***Преимущества***

+ Все операции, связанные с задачами, могут выполнять только авторизованные в системе пользователи;
+ Операции редактирования задачи могут выполняться только создателем и исполнителем данной задачи;
+ Обработка большинства типичных ошибок, связанных с некорректным вводом данных;
+ Автоматическая рассылка писем с информацией об изменении задач. Это находится в области ответственности задач Celery и очередей в RabbitMQ, что снижает нагрузку на сервер и делает весь сервис более отказоустойчивым;
+ Весь кэш проекта и сессии хранятся в Redis.


***Недостатки / недоработки***
+ В списке задач должны отображаться только те задачи, которые связаны с текущим пользователем;
+ Исполнитель задачи должен иметь возможность сменить исполнителя. В этом случае у задачи появится флаг «Делегировано»;
+ В идеале, должна быть возможность назначать задачу нескольким исполнителям, а не только одному. Таким образом, модель задач должна иметь поле «исполнители», которое является ссылкой «многие-ко-многим» на модели Пользователей;
+ Функционал приложения не покрыт тестами.
 
---


### Краткое руководство по быстрому запуску сервиса на вашем локальном компьютере

1. Данный проект существует в виде docker-контейнера, для его корректной сборки и запуска на вашем локальном компьютере вам потребуется установить актуальную версию [Docker Engine](https://docs.docker.com/engine/install/) (вер. от *19.03.0* и выше). 
2. Для сборки docker-образа вам потребуются файлы с переменными окружения *env.prod* и *env.db*. Поэтому переименуйте файлы *env.prod.example* и *env.db.example* из репозитория соответствующим образом. Эти файлы содержат переменные для корректной работы проекта. Значения для production среды уже настроены, обратите внимание на *EMAIL_HOST_USER* и *EMAIL_HOST_PASSWORD*, если вы хотите протестировать работу отправки электронной почты (см. раздел *«Отправка электронных писем»*).
3. Чтобы произвести сборку образа и запустить контейнеры, из корневой папки проекта выполните следующую команду в терминале:

    ```
    docker-compose -f docker-compose.prod.yml up -d --build
    ```

4. С помощью следующей команды вы можете создать суперпользователя:

    ```
    docker-compose -f docker-compose.prod.yml exec web python3 manage.py createsuperuser
    ```

5. В проекте используется база данных PostgreSQL в контейнере. С помощью интерактивного терминала psql вы можете проверить, успешно ли созданы базы данных и все связи:
    
    docker-compose -f docker-compose.prod.yml exec db psql --username=tasktable --dbname=tasktable_prod
    
    tasktable_prod=# \l     # Список баз данных
    
    tasktable_prod=# \c tasktable_prod
    You are now connected to database "tasktable_prod" as user "tasktable".
    
    tasktable_prod=# \dt    # Список связей

    tasktable_prod=# \q    # Выход из psql

6. В проекте используется сервер Nginx, который действует как обратный прокси-сервер для Gunicorn для обработки клиентских запросов, а также для обслуживания статических и мультимедийных файлов. Теперь вы можете перейти на сервер http://localhost:1337/ в своем браузере, вы перейдете к корню Api Root проекта. Войдите под учетными данными созданного вами суперпользователя (http://localhost:1337/admin/ или http://localhost:1337/api/login/) и попробуйте создать несколько тестовых объектов каждого типа. Вы можете создать нового пользователя (http://localhost:1337/api/registration/), задачи и комментарии к ним, используя функционал, описанный в разделе *«Основной функционал API приложения»*. Кроме того, вы можете перейти по адресу http://localhost:5555/, чтобы использовать панель Flower Dashboard для мониторинга задач Celery, если вы используете отправку электронной почты.


Другие полезные команды, которые могут вам пригодиться в ходе работы с docker-контейнером проекта:
    
    docker-compose -f docker-compose.prod.yml logs -f    # Вывод логов всех запущенных сервисов (Ctrl+C - для выхода)
    
    docker-compose -f docker-compose.prod.yml down -v   # Удалить все тома вместе с контейнерами
    
    docker images       # Вывод списка всех запущенных образов
    docker images -a    # Вывод списка всех доступных образов
    
    docker ps       # Вывод списка всех запущенных контейнеров
    docker ps -a    # Вывод списка всех контейнеров
    
    docker stop $(docker ps -a -q)      # Остановить все контейнеры
    docker rm $(docker ps -a -q)     # Удалить все контейнеры

    docker rm <ID_or_Name>    # Удаление конкретного контейнера по ID или по имени
    
    docker rmi $(docker images -f dangling=true -q)    # Удаление всех образов, не помеченных тэгами
    
    docker rmi <Image_ID>    # Удаление конкретного образа по ID
    
    docker rmi $(docker images -a -q)    # Удаление всех образов
    
    docker rmi -f $(docker images -a -q)    # Форсированное удаление всех образов
    
